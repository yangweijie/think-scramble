<?php

/**
 * PIE å®‰è£…åè„šæœ¬
 */

declare(strict_types=1);

echo "ğŸ‰ ThinkScramble Post-Installation Setup\n";
echo "========================================\n\n";

// æ£€æŸ¥æ“ä½œç³»ç»Ÿ
$os = PHP_OS_FAMILY;

// åˆ›å»ºé…ç½®ç›®å½•
$configDir = getenv('HOME') . '/.think-scramble';
if ($os === 'Windows') {
    $configDir = getenv('USERPROFILE') . '\\.think-scramble';
}

if (!is_dir($configDir)) {
    if (mkdir($configDir, 0755, true)) {
        echo "ğŸ“ Created config directory: {$configDir}\n";
    } else {
        echo "âš ï¸ Failed to create config directory: {$configDir}\n";
    }
}

// åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶
$configFile = $configDir . DIRECTORY_SEPARATOR . 'config.php';
if (!file_exists($configFile)) {
    $defaultConfig = <<<'PHP'
<?php

/**
 * ThinkScramble é»˜è®¤é…ç½®
 */

return [
    'info' => [
        'title' => 'My API',
        'version' => '1.0.0',
        'description' => 'API documentation generated by ThinkScramble',
    ],
    'servers' => [
        [
            'url' => 'http://localhost:8000',
            'description' => 'Development server',
        ],
    ],
    'security' => [
        'enabled_schemes' => [
            'BearerAuth',
            'ApiKeyAuth',
        ],
    ],
    'cache' => [
        'driver' => 'file',
        'file' => [
            'path' => sys_get_temp_dir() . '/think-scramble-cache',
        ],
    ],
    'export' => [
        'formats' => [
            'json',
            'yaml',
            'postman',
            'insomnia',
        ],
    ],
    'performance' => [
        'monitor' => true,
        'cache_ttl' => 3600,
    ],
];
PHP;

    if (file_put_contents($configFile, $defaultConfig)) {
        echo "ğŸ“„ Created default config: {$configFile}\n";
    } else {
        echo "âš ï¸ Failed to create config file: {$configFile}\n";
    }
}

// åˆ›å»ºç¼“å­˜ç›®å½•
$cacheDir = sys_get_temp_dir() . '/think-scramble-cache';
if (!is_dir($cacheDir)) {
    if (mkdir($cacheDir, 0755, true)) {
        echo "ğŸ’¾ Created cache directory: {$cacheDir}\n";
    } else {
        echo "âš ï¸ Failed to create cache directory: {$cacheDir}\n";
    }
}

// åˆ›å»ºç¤ºä¾‹é¡¹ç›®é…ç½®
$exampleConfig = $configDir . DIRECTORY_SEPARATOR . 'example-project.php';
if (!file_exists($exampleConfig)) {
    $exampleContent = <<<'PHP'
<?php

/**
 * ThinkScramble é¡¹ç›®é…ç½®ç¤ºä¾‹
 * 
 * å¤åˆ¶æ­¤æ–‡ä»¶åˆ°ä½ çš„ ThinkPHP é¡¹ç›®æ ¹ç›®å½•ï¼Œé‡å‘½åä¸º scramble.php
 */

return [
    'info' => [
        'title' => 'My ThinkPHP API',
        'version' => '1.0.0',
        'description' => 'A comprehensive API for my ThinkPHP application',
        'contact' => [
            'name' => 'API Support',
            'email' => 'support@example.com',
            'url' => 'https://example.com/support',
        ],
        'license' => [
            'name' => 'MIT',
            'url' => 'https://opensource.org/licenses/MIT',
        ],
    ],
    
    'servers' => [
        [
            'url' => 'http://localhost:8000',
            'description' => 'Development server',
        ],
        [
            'url' => 'https://api.example.com',
            'description' => 'Production server',
        ],
    ],
    
    'paths' => [
        'controllers' => 'app/controller',
        'models' => 'app/model',
        'validate' => 'app/validate',
    ],
    
    'security' => [
        'enabled_schemes' => [
            'BearerAuth',
            'ApiKeyAuth',
            'SessionAuth',
        ],
        'global_security' => [
            ['BearerAuth' => []],
        ],
    ],
    
    'cache' => [
        'driver' => 'file',
        'file' => [
            'path' => './runtime/scramble-cache',
        ],
        'ttl' => 3600,
    ],
    
    'export' => [
        'default_format' => 'json',
        'formats' => [
            'json',
            'yaml', 
            'postman',
            'insomnia',
        ],
    ],
    
    'performance' => [
        'monitor' => true,
        'cache_analysis' => true,
        'optimize_autoloader' => true,
    ],
    
    'plugins' => [
        'enabled' => [],
        'directories' => [
            './plugins',
        ],
    ],
];
PHP;

    if (file_put_contents($exampleConfig, $exampleContent)) {
        echo "ğŸ“‹ Created example config: {$exampleConfig}\n";
    }
}

// æ£€æŸ¥ shell é…ç½®æ–‡ä»¶å¹¶æ·»åŠ è¡¥å…¨
$shells = [
    'bash' => [
        'file' => getenv('HOME') . '/.bashrc',
        'completion' => 'complete -W "--help --version --output --config --format --controllers --models --middleware --validate --stats --watch" scramble',
    ],
    'zsh' => [
        'file' => getenv('HOME') . '/.zshrc', 
        'completion' => 'compdef _gnu_generic scramble',
    ],
];

foreach ($shells as $shell => $config) {
    if (file_exists($config['file'])) {
        $content = file_get_contents($config['file']);
        
        if (strpos($content, 'scramble') === false) {
            echo "ğŸš Adding {$shell} completion to {$config['file']}\n";
            
            $addition = "\n# ThinkScramble completion\n" . $config['completion'] . "\n";
            file_put_contents($config['file'], $addition, FILE_APPEND);
        }
    }
}

// æ˜¾ç¤ºå¿«é€Ÿå¼€å§‹æŒ‡å—
echo "\nğŸš€ Quick Start Guide:\n";
echo "====================\n\n";

echo "1. ğŸ“ Navigate to your ThinkPHP project:\n";
echo "   cd /path/to/your/thinkphp/project\n\n";

echo "2. ğŸ“„ Copy example config (optional):\n";
echo "   cp {$exampleConfig} ./scramble.php\n\n";

echo "3. ğŸ¯ Generate API documentation:\n";
echo "   scramble --output=api.json\n\n";

echo "4. ğŸ›¡ï¸ Include middleware analysis:\n";
echo "   scramble --output=api.json --middleware\n\n";

echo "5. ğŸ“Š Export to different formats:\n";
echo "   scramble --format=postman --output=api.postman.json\n";
echo "   scramble --format=insomnia --output=api.insomnia.json\n\n";

echo "6. ğŸ‘€ Watch for file changes:\n";
echo "   scramble --watch --output=api.json\n\n";

echo "7. ğŸ“ˆ View statistics:\n";
echo "   scramble --stats\n\n";

// æ˜¾ç¤ºæœ‰ç”¨çš„é“¾æ¥
echo "ğŸ“š Resources:\n";
echo "=============\n";
echo "ğŸ“– Documentation: https://github.com/yangweijie/think-scramble\n";
echo "ğŸ¯ Examples: https://github.com/yangweijie/think-scramble/tree/main/example\n";
echo "ğŸ› Issues: https://github.com/yangweijie/think-scramble/issues\n";
echo "ğŸ’¬ Discussions: https://github.com/yangweijie/think-scramble/discussions\n\n";

// æ£€æŸ¥æ›´æ–°æé†’
echo "ğŸ’¡ Tips:\n";
echo "========\n";
echo "â€¢ Run 'pie status yangweijie/think-scramble' to check installation status\n";
echo "â€¢ Run 'pie update yangweijie/think-scramble' to update to the latest version\n";
echo "â€¢ Use 'scramble --help' to see all available options\n";
echo "â€¢ Create a 'scramble.php' config file in your project for custom settings\n\n";

echo "ğŸ‰ Installation complete! Happy documenting! ğŸ‰\n";
