# YAML 导出功能修复

## 问题描述

在运行 `php think scramble:export -f yaml` 命令时，遇到以下错误：

```
Export failed: YAML extension is not available
```

这是因为 PHP 环境中没有安装 YAML 扩展。

## 解决方案

我们创建了一个内置的 YAML 生成器，无需安装额外的 PHP 扩展即可导出 YAML 格式的 API 文档。

### 🔧 修复内容

1. **新增 YamlGenerator 类** (`src/Utils/YamlGenerator.php`)
   - 提供纯 PHP 实现的 YAML 生成功能
   - 支持复杂的嵌套结构
   - 正确处理特殊字符和 YAML 关键字
   - 智能检测是否需要引号

2. **修改 ExportCommand** (`src/Command/ExportCommand.php`)
   - 使用新的 YamlGenerator 替代原生 YAML 扩展
   - 优先使用原生扩展，如果不可用则使用内置生成器

3. **修改 DocsController** (`src/Controller/DocsController.php`)
   - 更新 YAML 端点以使用新的生成器
   - 移除对 YAML 扩展的强制依赖

4. **修改 OpenApiGenerator** (`src/Generator/OpenApiGenerator.php`)
   - 更新 `generateYaml()` 方法使用新的生成器

### 🚀 使用方法

现在你可以正常使用 YAML 导出功能：

```bash
# 导出为 YAML 格式
php think scramble:export -f yaml

# 指定输出文件
php think scramble:export -f yaml -o docs/api.yaml

# 生成 YAML 格式文档
php think scramble:generate --format=yaml

# 通过 Web 接口访问 YAML
curl http://localhost:8000/docs/api.yaml
```

### 📋 功能特性

#### 1. 智能 YAML 生成
- **自动类型检测**：正确处理字符串、数字、布尔值、null
- **数组处理**：区分顺序数组和关联数组
- **嵌套结构**：支持任意深度的嵌套对象和数组
- **特殊字符转义**：自动转义引号、换行符等特殊字符

#### 2. 兼容性
- **向后兼容**：如果系统安装了 YAML 扩展，优先使用原生扩展
- **降级处理**：如果原生扩展不可用，自动使用内置生成器
- **错误处理**：提供详细的错误信息和建议

#### 3. OpenAPI 优化
- **文档头部**：自动添加 OpenAPI 规范注释
- **时间戳**：包含生成时间信息
- **格式化**：符合 OpenAPI 3.0 YAML 规范

### 📝 示例输出

生成的 YAML 文档格式如下：

```yaml
# OpenAPI 3.0 Specification
# Generated by ThinkScramble
# 2025-01-25 23:45:00

openapi: 3.0.0
info:
  title: My API
  version: 1.0.0
  description: API documentation generated by ThinkScramble
servers:
  - url: https://api.example.com
    description: Production server
paths:
  /users:
    get:
      summary: Get users
      tags:
        - users
      responses:
        "200":
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/User"
components:
  schemas:
    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
          maxLength: 100
      required:
        - id
        - name
```

### 🔍 技术细节

#### YamlGenerator 类方法

```php
// 基本编码
YamlGenerator::encode(array $data, int $indent = 0): string

// OpenAPI 专用生成
YamlGenerator::generateOpenApiYaml(array $document): string

// 智能生成（优先使用原生扩展）
YamlGenerator::dump(array $data): string

// 检查原生扩展支持
YamlGenerator::hasNativeYamlSupport(): bool
```

#### 特殊处理规则

1. **字符串引号规则**
   - 包含 YAML 特殊字符时自动加引号
   - YAML 关键字（true、false、null 等）自动加引号
   - 数字字符串自动加引号以避免类型混淆

2. **数组处理**
   - 顺序数组使用 `- item` 格式
   - 关联数组使用 `key: value` 格式
   - 嵌套数组正确缩进

3. **类型转换**
   - `null` → `null`
   - `true` → `true`
   - `false` → `false`
   - 数字保持原格式
   - 字符串根据内容决定是否加引号

### 🧪 测试

运行测试以验证功能：

```bash
# 运行 YAML 生成器测试
php vendor/bin/phpunit tests/YamlGeneratorTest.php

# 测试导出命令
php think scramble:export -f yaml --output=test.yaml

# 验证生成的文件
cat test.yaml
```

### 🔧 故障排除

#### 1. 导出失败
```bash
# 检查权限
ls -la exports/

# 创建输出目录
mkdir -p exports/

# 使用绝对路径
php think scramble:export -f yaml -o /path/to/output.yaml
```

#### 2. 格式问题
```bash
# 验证 YAML 格式
php -r "
\$yaml = file_get_contents('exports.yaml');
echo 'YAML file size: ' . strlen(\$yaml) . ' bytes' . PHP_EOL;
echo 'First 200 chars:' . PHP_EOL . substr(\$yaml, 0, 200) . PHP_EOL;
"
```

#### 3. 性能问题
对于大型 API 文档，YAML 生成可能需要更多时间。可以考虑：
- 使用 JSON 格式（更快）
- 分批导出
- 增加 PHP 内存限制

### 📈 性能对比

| 方法 | 速度 | 内存使用 | 依赖 |
|------|------|----------|------|
| 原生 YAML 扩展 | 最快 | 最少 | 需要扩展 |
| 内置生成器 | 中等 | 中等 | 无依赖 |
| Symfony YAML | 较慢 | 较多 | 需要包 |

### 🎯 最佳实践

1. **生产环境**：建议安装 YAML 扩展以获得最佳性能
2. **开发环境**：使用内置生成器即可满足需求
3. **CI/CD**：在构建脚本中预生成 YAML 文档
4. **版本控制**：将生成的 YAML 文件加入 `.gitignore`

### 🔄 升级说明

此修复完全向后兼容，无需修改现有代码。如果你之前因为 YAML 扩展问题无法使用 YAML 导出功能，现在可以直接使用。

如果你的系统已经安装了 YAML 扩展，系统会自动使用原生扩展以获得更好的性能。
